import { Callout, Cards, Card, FileTree, Steps, Tabs } from "nextra/components";
import { LatestReadings } from "../../../components/ui/sections/latest-readings";

# Bi-Temporal Events

<img className="rounded-2xl border-2 border-gray-800" src="/assets/read/events_commands.png" alt="Two Commands CQRS" />

## Introduction

What are bi-temporal events? They are simply regular events with some timestamp'ish Date field like `valid_at`.

Examples of these events are: `BlackFridayProductDiscount` | `ApplySalaryIncreaseAt` | etc.

*In a nutshell, bi-temporal means that we can work with **past** and **future**. Martin Fowler describes it as a 2 distinct vectors(each with time) one for when we wanted to do something and when it should be applied.*

> [Martin Fowler focuses on salaries](https://martinfowler.com/articles/bitemporal-history.html), they were used as an example for **bitemporal-history**.

## Top level view

<img className="rounded-2xl border-2 border-gray-800" src="/assets/read/bitemporal_ex.png" alt="Simplest showcase of time and 2 start with end commands" />

## Examples

> For Bi-Temporal Events we should be using **Event Sourcing** with any kind of an EventStore Database*(even raw SQL/NoSQL-with-Timeseries)*. Otherwise we will end up with row/doc fields: `timestamp`, `valid_at`, `valid_til`.

### Salary Increase
- ApplySalaryIncrease:
    > Command comes from CQRS or CQS if you are using one of them. This is simple showcase for a basic command.
    ```typescript copy
    class ApplySalaryIncreaseAt extends Command {
        data: {employeeID: string, increasedSalaryValue: number}
        validAt: Date
        timestamp = new Date()
        version = 1

        constructor(employeeID: string, increasedSalaryValue: number, validAt: Date) {
            super({employeeID, increasedSalaryValue})
            this.validAt = validAt
        }
    }
    ```
    And handler for this command:
    ```typescript copy
    @CommandHandler(ApplySalaryIncreaseAt)
    class ApplySalaryIncreaseAtHandler implements ICommandHandler<ApplySalaryIncreaseAt> {
        constructor(private repository: SalariesRepository, private politic: SalariesPolitic) {}

        async execute(command: ApplySalaryIncreaseAt): Promise<void> {
            await this.politic.isValidSalaryIncreaseOrThrow({...command.data, validAt: command.validAt})
            const accountant = this.repository.getEmployeeAccountant(command.data.employeeID)
            await accountant.increaseSalaryAt({
                newValue: command.data.increasedSalaryValue,
                validSince: command.validAt
            })
        }
    }
    ```

## What it gives us?

If you are using `Event Sourcing` you will have perfect history due to the **append-only** rule.

Combine data in event store stored as a timeline of events with `valid_at` fields and you will be able to activate:
- pricing changes,
- new rules for car parts production,
- black friday rules
- salaries changes over period of time,
- etc.

## Next

*Check next:*

<Cards>
  <Card icon={<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
    <path d="M14.763.075A.5.5 0 0 1 15 .5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V14h-1v1.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V10a.5.5 0 0 1 .342-.474L6 7.64V4.5a.5.5 0 0 1 .276-.447l8-4a.5.5 0 0 1 .487.022M6 8.694 1 10.36V15h5zM7 15h2v-1.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5V15h2V1.309l-7 3.5z"/>
    <path d="M2 11h1v1H2zm2 0h1v1H4zm-2 2h1v1H2zm2 0h1v1H4zm4-4h1v1H8zm2 0h1v1h-1zm-2 2h1v1H8zm2 0h1v1h-1zm2-2h1v1h-1zm0 2h1v1h-1zM8 7h1v1H8zm2 0h1v1h-1zm2 0h1v1h-1zM8 5h1v1H8zm2 0h1v1h-1zm2 0h1v1h-1zm0-2h1v1h-1z"/>
  </svg>} title="CQRS" href="/learn/architecture/cqrs/" />
  
  <Card icon={<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
    <path d="M14.763.075A.5.5 0 0 1 15 .5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V14h-1v1.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V10a.5.5 0 0 1 .342-.474L6 7.64V4.5a.5.5 0 0 1 .276-.447l8-4a.5.5 0 0 1 .487.022M6 8.694 1 10.36V15h5zM7 15h2v-1.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5V15h2V1.309l-7 3.5z"/>
    <path d="M2 11h1v1H2zm2 0h1v1H4zm-2 2h1v1H2zm2 0h1v1H4zm4-4h1v1H8zm2 0h1v1h-1zm-2 2h1v1H8zm2 0h1v1h-1zm2-2h1v1h-1zm0 2h1v1h-1zM8 7h1v1H8zm2 0h1v1h-1zm2 0h1v1h-1zM8 5h1v1H8zm2 0h1v1h-1zm2 0h1v1h-1zm0-2h1v1h-1z"/>
  </svg>} title="Event Store for Event Sourcning" href="/learn/typescript/event-store/" />
</Cards>

<section className="rounded-2xl bg-lines flex mt-10 mb-20 h-20 w-full"></section>

<LatestReadings />