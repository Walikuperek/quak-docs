import { Callout, Cards, Card, FileTree, Steps, Tabs } from "nextra/components";
import { LatestReadings } from "../../../components/ui/sections/latest-readings";
import { ArchitectureTag } from "../../../components/tags/architecture";

<section className="header__height w-full rounded-2xl bg-indigo-900 bg-opacity-10 border-2 border-indigo-500 mt-2">
    <article className="flex flex-col align-between h-full relative">
        <div className="absolute top-0 left-0 p-2">
            <ArchitectureTag/>
        </div>
        <section className="shadow-lg flex align-center justify-center gap-3 h-full overflow-hidden">
            <div className="flex flex-col bg-violet-900 h-40 w-40 p-2 mt-20 text-white font-bold rounded">
                <p>Architecture</p>
                <hr/>
                <ul>
                    <li className="flex items-center gap-2 p-1 bg-violet-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             className="bi bi-bank" viewBox="0 0 16 16">
                            <path
                                d="m8 0 6.61 3h.89a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v7a.5.5 0 0 1 .485.38l.5 2a.498.498 0 0 1-.485.62H.5a.498.498 0 0 1-.485-.62l.5-2A.5.5 0 0 1 1 13V6H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 3h.89zM3.777 3h8.447L8 1zM2 6v7h1V6zm2 0v7h2.5V6zm3.5 0v7h1V6zm2 0v7H12V6zM13 6v7h1V6zm2-1V4H1v1zm-.39 9H1.39l-.25 1h13.72z"/>
                        </svg>
                        <span>CQRS</span>
                    </li>
                    <li className="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             className="bi bi-bank" viewBox="0 0 16 16">
                            <path
                                d="m8 0 6.61 3h.89a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v7a.5.5 0 0 1 .485.38l.5 2a.498.498 0 0 1-.485.62H.5a.498.498 0 0 1-.485-.62l.5-2A.5.5 0 0 1 1 13V6H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 3h.89zM3.777 3h8.447L8 1zM2 6v7h1V6zm2 0v7h2.5V6zm3.5 0v7h1V6zm2 0v7H12V6zM13 6v7h1V6zm2-1V4H1v1zm-.39 9H1.39l-.25 1h13.72z"/>
                        </svg>
                        <span className="text-violet-500">Hexagonal</span>
                    </li>
                    <li className="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             className="bi bi-bank" viewBox="0 0 16 16">
                            <path
                                d="m8 0 6.61 3h.89a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v7a.5.5 0 0 1 .485.38l.5 2a.498.498 0 0 1-.485.62H.5a.498.498 0 0 1-.485-.62l.5-2A.5.5 0 0 1 1 13V6H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 3h.89zM3.777 3h8.447L8 1zM2 6v7h1V6zm2 0v7h2.5V6zm3.5 0v7h1V6zm2 0v7H12V6zM13 6v7h1V6zm2-1V4H1v1zm-.39 9H1.39l-.25 1h13.72z"/>
                        </svg>
                        <span className="text-violet-500">Microservice</span>
                    </li>
                    <li className="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             className="bi bi-bank" viewBox="0 0 16 16">
                            <path
                                d="m8 0 6.61 3h.89a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v7a.5.5 0 0 1 .485.38l.5 2a.498.498 0 0 1-.485.62H.5a.498.498 0 0 1-.485-.62l.5-2A.5.5 0 0 1 1 13V6H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 3h.89zM3.777 3h8.447L8 1zM2 6v7h1V6zm2 0v7h2.5V6zm3.5 0v7h1V6zm2 0v7H12V6zM13 6v7h1V6zm2-1V4H1v1zm-.39 9H1.39l-.25 1h13.72z"/>
                        </svg>
                        <span className="text-violet-500">...</span>
                    </li>
                </ul>
            </div>
        </section>
        <header className="flex flex-col px-4 pb-4 pt-4">
            <div className="flex flex-row justify-between items-center mb-3 border-b-2 border-b-indigo-300">
                <h1 className="text-2xl font-bold">CQRS</h1>
                <p className="mt-2 text-lg text-gray-500">Kacper Walczak &middot; 06-05-2024</p>
            </div>
            <p className="mt-2 text-lg">Lets learn how to use CQRS in your project.</p>
        </header>
    </article>
</section>

## What is CQRS?

CQRS stands for `Command Query Responsibility Segregation`.

It is a design pattern that separates the read and write operations of a data source.

> Additionally, it allows to use separate Database for reading and writing(what can improve scaling by a lot).

<img src="/assets/read/cqrs_ex.png" className="rounded-2xl border-2 border-gray-800 max-h-[350px] mx-auto mt-4" alt="CQRS schema with events and database for writing and reading" />

## When to use?
- Your business logic is going to evolve/change often
- Your model requires to be read with multiple data projections
- It is required to optimize reads over writes and vice-versa

## When to avoid?
- You are building CRUD, don't use there CQRS
- You are starting new project and you are lacking domain experts
- You don't want to introduce any reactive patterns(events/commands/queries needs to be handled and emited by some bus)

## Examples

### COMMAND
- ApplySalaryIncrease:
    ```typescript copy
    class ApplySalaryIncreaseAt extends Command {
        data: {employeeID: string, increasedSalaryValue: number}
        validAt: Date
        timestamp = new Date()
        version = 1

        constructor(employeeID: string, increasedSalaryValue: number, validAt: Date) {
            super({employeeID, increasedSalaryValue})
            this.validAt = validAt
        }
    }
    ```
    And handler for this command:
    ```typescript copy
    @CommandHandler(ApplySalaryIncreaseAt)
    class ApplySalaryIncreaseAtHandler implements ICommandHandler<ApplySalaryIncreaseAt> {
        constructor(private repository: SalariesRepository, private politic: SalariesPolitic) {}

        async execute(command: ApplySalaryIncreaseAt): Promise<void> {
            await this.politic.isValidSalaryIncreaseOrThrow({...command.data, validAt: command.validAt})
            const accountant = this.repository.getEmployeeAccountant(command.data.employeeID)
            await accountant.increaseSalaryAt({
                newValue: command.data.increasedSalaryValue,
                validSince: command.validAt
            })
        }
    }
    ```
### QUERY
- GetLastEmployeeSalaryIncrease:
    ```typescript copy
    class GetLastEmployeeSalaryIncrease extends Query {
        data: {employeeID: string}

        constructor(employeeID: string) {
            super({ employeeID })
        }
    }
    ```
    And handler for this query:
    ```typescript copy
    @CommandHandler(GetLastEmployeeSalaryIncrease)
    class GetLastEmployeeSalaryIncreaseHandler implements IQueryHandler<GetLastEmployeeSalaryIncrease> {
        constructor(private repository: SalariesRepository) {}

        async execute(query: GetLastEmployeeSalaryIncrease): Promise<any[]> {
            return this.repository.getEmployeeLastSalaryIncrease(query.data.employeeID)
        }
    }
    ```
### EVENT
- SalaryIncreased:
    ```typescript copy
    class SalaryIncreasedEvent {
        constructor(public readonly employeeID: string) {}
    }
    ```
    Call this event after some logic with:
    ```typescript copy
    this.eventBus.publish(new SalaryIncreasedEvent(employeeID));
    ```
    And handler for this event:
    ```typescript copy
    @EventsHandler(SalaryIncreasedEvent)
    class SalaryIncreasedEventHandler implements IEventHandler<SalaryIncreasedEvent> {
        constructor(private repository: SalariesRepository, private email: EmailSender) {}

        async handle(event: SalaryIncreasedEvent): Promise<void> {
            // do job here, like: 
            //   const {employee, accountant, changes} = await repository.fetchLastEmployeeChanges(event.employeeID)
            //   await email.notify(accountant, {employee, changes})
        }
    }
    ```

## Next

In this article we have learned how to and when utilize CQRS architecture.

> Check `Web Architectures` to learn more about different architectures.

*Check next:*

<Cards>
  <Card icon={<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
    <path d="M14.763.075A.5.5 0 0 1 15 .5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V14h-1v1.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V10a.5.5 0 0 1 .342-.474L6 7.64V4.5a.5.5 0 0 1 .276-.447l8-4a.5.5 0 0 1 .487.022M6 8.694 1 10.36V15h5zM7 15h2v-1.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5V15h2V1.309l-7 3.5z"/>
    <path d="M2 11h1v1H2zm2 0h1v1H4zm-2 2h1v1H2zm2 0h1v1H4zm4-4h1v1H8zm2 0h1v1h-1zm-2 2h1v1H8zm2 0h1v1h-1zm2-2h1v1h-1zm0 2h1v1h-1zM8 7h1v1H8zm2 0h1v1h-1zm2 0h1v1h-1zM8 5h1v1H8zm2 0h1v1h-1zm2 0h1v1h-1zm0-2h1v1h-1z"/>
  </svg>} title="Web Architectures" href="/learn/architecture/web-architectures/" />
</Cards>

<section className="rounded-2xl bg-lines flex mt-10 mb-20 h-20 w-full"></section>

<LatestReadings />
