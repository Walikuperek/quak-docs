import { FileTree, Tabs } from "nextra/components";
import { LatestReadings } from "../../../components/ui/sections/latest-readings";
import { NodeTag } from "../../../components/tags/node";

<section className="header__height w-full rounded-2xl bg-green-900 bg-opacity-10 border-2 border-green-500 mt-2">
    <article className="flex flex-col align-between h-full relative">
        <div className="absolute top-0 left-0 p-2">
            <NodeTag/>
        </div>
        <section className="shadow-lg flex align-center justify-center gap-3 h-full overflow-hidden">
            <div className="flex rounded flex-col justify-evenly items-center bg-orange-500 h-40 w-40 p-1 mt-20 text-white font-bold">
                <p>Deploy</p>
                <div className="flex justify-center items-center bg-black border-dashed border-yellow-500 border-2 h-20 w-20">
                    <p>CPanel</p>
                </div>
            </div>
        </section>
        <header className="flex flex-col px-4 pb-4 pt-4">
            <div className="flex flex-row justify-between items-center mb-3 border-b-2 border-b-green-300">
                <h1 className="text-2xl font-bold">Deploy to CPanel</h1>
                <p className="mt-2 text-lg text-gray-500">Kacper Walczak &middot; 19-05-2024</p>
            </div>
            <p className="mt-2 text-lg">CD - Deploy static HTML to CPanel.</p>
        </header>
    </article>
</section>

## Introduction

In this article we will learn how to deploy a static HTML website to a shared hosting CPanel using a CD pipeline.

> It is built to work for anyone who has proper account on CPanel hosting provider.
>
> Main goal is to automate deployment process of static HTML website to CPanel without need of SSH or manual actions.

We will see how [quak.com.pl](https://quak.com.pl) is deployed to CPanel using `puppetter` and `node.js` in an automated process of Continuous Deployment.

## Results

We will have a CD pipeline that will build Nextra `.mdx` pages, export to static HTML files and where deployment process will look like this:

```bash copy
> node ./index.js "Archive_19_05_2024_node_init.zip"

🚀 Starting deployment (Archive_19_05_2024_node_init.zip)
🌐 Opened browser (1920x1080)
🔑 Logging in to CPanel (your-username)
    Checked username
    Logged in
📂 Opened File Manager page
📬 Opened Upload File page
    Uploading from path: ../../out/Archive_19_05_2024_node_init.zip
    Uploaded file
📂 Opened File Manager page
    Extracting file: Archive_19_05_2024_node_init.zip
    Extracted file
🚢 Deployed!
🔒 Closed browser, total time: 16s
```


## Prerequisites

[quak.com.pl](https://quak.com.pl) is a static HTML website that is hosted on a shared hosting provider.

To recreate same pipeline in your app you will need to have:

- A CPanel account on your hosting provider.
- Your static HTML website.
- A `node.js` runtime.
- MacOS is used in this article, but you can use any OS with some tweaks to the zip creation step in case e.g. Windows.

## Deploy to CPanel

We will deploy our website to CPanel using a CD pipeline.

Pipeline is started inside `quak-docs` repository with a command like this:

```bash copy
$ sh scripts/build-deploy.sh 'Archive_19_05_2024_3.zip'
```

Pipeline will:

1. Build the website.
2. Export the website to static HTML.
3. Zip the website as `Archive_19_05_2024_3.zip`.
4. Upload the website to CPanel.
5. Unzip the website.
6. Store screenshots of whole deployment process in `scripts/deploy/process-screenshots` directory.

To achieve this we will use `Nextra` our website main framework to build and export to static HTML files, `bash` for running terminal commands in batch, `puppeteer` to visit CPanel via Chrome DevTools and `node.js` as our runtime for javascript code.

### Website repository structure

```text
quak-docs
├── out - exported static HTML files
├── pages - Nextra pages
├── scripts - bash scripts
│   ├── build-deploy.sh - main script
│   └── deploy - node script for deploying
└── ...
```

And visually:
<FileTree>
  <FileTree.Folder name="quak-docs" defaultOpen>
    <FileTree.Folder name="out"></FileTree.Folder>
    <FileTree.Folder name="pages"></FileTree.Folder>
    <FileTree.Folder name="scripts" defaultOpen>
      <FileTree.File name="build-deploy.sh" />
      <FileTree.Folder name="deploy">
        <FileTree.File name=".env" />
        <FileTree.File name="deploy.js" />
        <FileTree.File name="index.js" />
        <FileTree.File name="package.json" />
        <FileTree.File name="pages.js" />
        <FileTree.File name="util.js" />
      </FileTree.Folder>
    </FileTree.Folder>
    <FileTree.File name="..." />
  </FileTree.Folder>
</FileTree>

### Build deploy script

We want to click on the CPanel, log in, open file manager, upload the zip file and unzip it.

#### Final structure

<FileTree>
  <FileTree.Folder name="quak-docs" defaultOpen>
    <FileTree.Folder name="scripts" defaultOpen>
      <FileTree.File name="build-deploy.sh" />
      <FileTree.Folder name="deploy" defaultOpen>
        <FileTree.Folder name="process-screenshots"></FileTree.Folder>
        <FileTree.File name=".env" />
        <FileTree.File name="deploy.js" />
        <FileTree.File name="index.js" />
        <FileTree.File name="package.json" />
        <FileTree.File name="pages.js" />
        <FileTree.File name="util.js" />
      </FileTree.Folder>
    </FileTree.Folder>
    <FileTree.File name="..." />
  </FileTree.Folder>
</FileTree>

#### Final files content

> **Page Object Model** pattern is used to help with page behavior and selectors management.

<Tabs items={['index.js', 'deploy.js', 'pages.js', 'util.js', '.env', 'package.json']}>
  <Tabs.Tab>
      ```js copy
      import { Deploy } from './deploy.js';
      import dotenv from 'dotenv';

      // load .env variables
      dotenv.config();
      if (!process.env || !process.env.USERNAME || !process.env.PASSWORD) {
          console.error('🚨 Missing USERNAME or PASSWORD in .env file');
          process.exit(1);
      }

      const USER = {
          username: process.env.USERNAME,
          password: process.env.PASSWORD
      };

      (async () => {
          const deploy = new Deploy();
          await deploy.init(USER, getFilePathOrError());
          await deploy.run();
          await deploy.close();
      })();

      function getFilePathOrError() {
          if (process.argv.length < 3) {
              console.error('🚨 No file path provided, proper command `node ./index.js path/to/file.zip` or `pnpm run deploy path/to/file.zip`');
              process.exit(1);
          }
          return '../../out/' + process.argv[2];
      }
      ```
  </Tabs.Tab>
  <Tabs.Tab>
      ```js copy
      import puppeteer from 'puppeteer';
      import { CheckUsernamePage, CPanelPage, FileManagerPage, LoginPage, UploadFilesPage } from './pages.js';
      import { nav, indent } from './util.js';

      /**
       * @typedef {Object} Credentials to log in to CPanel
       * @property {string} username
       * @property {string} password
       */

      export class Deploy {
          /** Gets name of the file from path */
          filenameFactory = (path) => path.includes('/') ? path.split('/').pop() : path;

          constructor() {
              /** @type {Credentials | null} */
              this.USER = null;
              this.browser = null;
              this.page = null;
              this.startedAt = new Date();
          }

          /**
           * @param {Credentials} loginAs
           * @param {string} deployFilePath - path to packageZip to deploy
           * @returns {Promise<void>}
           */
          async init(loginAs, deployFilePath) {
              console.log('🚀 Starting deployment (' + this.filenameFactory(deployFilePath) + ')');
              this.USER = loginAs;
              this.browser = await puppeteer.launch();
              this.page = await this.browser.newPage();
              this.deployFilePath = deployFilePath;
              await this.page.setViewport({width: 1920, height: 1080});
              console.log('🌐 Opened browser (1920x1080)');
          }

          async close() {
              await this.browser.close();
              const toSeconds = (ms) => Math.floor(ms / 1000);
              console.log('🔒 Closed browser, total time: ' + toSeconds(new Date() - this.startedAt) + 's');
          }

          async run() {
              await this.loginToCPanel();
              await this.openFileManager();
              await this.openUploadFile();
              await this.uploadFile(this.deployFilePath);
              await this.openFileManager();
              await this.extractFile(this.filenameFactory(this.deployFilePath));
              console.log('🚢 Deployed!');
          }

          async loginToCPanel() {
              console.log('🔑 Logging in to CPanel (' + this.USER.username + ')');
              const checkUsernamePage = new CheckUsernamePage(this.page);
              await checkUsernamePage.open();
              await checkUsernamePage.initUsername(this.USER.username);
              await nav.waitFor(this.page, checkUsernamePage.submitToOpenLoginPage.bind(checkUsernamePage));
              console.log(indent('Checked username'));
              await this.page.screenshot({path: 'process-screenshots/1-opened-login.png'});

              const loginPage = new LoginPage(this.page);
              await loginPage.initUsername(this.USER.username);
              await loginPage.initPassword(this.USER.password);
              await nav.waitFor(this.page, loginPage.submitToOpenCPanel.bind(loginPage));
              await this.page.screenshot({path: 'process-screenshots/2-opened-cpanel.png'});
              console.log(indent('Logged in'));
          }

          async openFileManager() {
              const cPanelPage = new CPanelPage(this.page);
              await nav.waitFor(this.page, cPanelPage.openFileManager.bind(cPanelPage));
              await this.page.screenshot({path: 'process-screenshots/3-opened-file-manager.png'});
              console.log('📂 Opened File Manager page');
          }

          async openUploadFile() {
              const uploadFilePage = new UploadFilesPage(this.page);
              await nav.waitFor(this.page, uploadFilePage.openUploadFilePage.bind(uploadFilePage));
              await this.page.screenshot({path: 'process-screenshots/4-opened-upload-file-page.png'});
              console.log('📬 Opened upload file page');
          }

          /**
           * Uploads file to the server
           * @param {string} pathToFile - path to file to upload
           * @returns {Promise<void>}
           */
          async uploadFile(pathToFile) {
              const uploadFilesPage = new UploadFilesPage(this.page);
              console.log(indent('Uploading from path:'), pathToFile);
              await uploadFilesPage.uploadFile(pathToFile);
              await this.page.screenshot({path: 'process-screenshots/5-uploaded-file.png'});
              console.log(indent('Uploaded file'));
          }

          /**
           * Extracts file on the server
           * @param {string} filename
           * @returns {Promise<void>}
           */
          async extractFile(filename) {
              const fileManagerPage = new FileManagerPage(this.page);
              console.log(indent('Extracting file:'), filename);
              await fileManagerPage.extractFile(filename);
              await this.page.screenshot({path: 'process-screenshots/6-extracted-file.png'});
              console.log(indent('Extracted file'));
          }
      }
      ```
  </Tabs.Tab>
  <Tabs.Tab>
      ```js copy
      import { time } from './util.js';

      export class CheckUsernamePage {
          url = 'https://adminpanel.your-domain-here.com/';
          usernameInputSelector = '#input-login';
          submitBtnSelector = 'button[type="submit"]';

          constructor(page) {
              this.page = page;
          }

          async open() {
              await this.page.goto(this.url);
          }

          async initUsername(username) {
              await this.page.type(this.usernameInputSelector, username);
          }

          async submitToOpenLoginPage() {
              await this.page.click(this.submitBtnSelector);
          }
      }

      export class LoginPage {
          usernameInputSelector = '#user';
          passwordInputSelector = '#pass';
          submitBtnSelector = '#login_submit';

          constructor(page) {
              this.page = page;
          }

          async initUsername(username) {
              await this.page.type(this.usernameInputSelector, username);
          }

          async initPassword(password) {
              await this.page.type(this.passwordInputSelector, password);
          }

          async submitToOpenCPanel() {
              await this.page.click(this.submitBtnSelector);
          }
      }

      export class CPanelPage {
          fileManagerPageUrlFactory = (cPanelUrl) => `${cPanelUrl}/filemanager/index.html`;

          constructor(page) {
              this.page = page;
          }

          async openFileManager() {
              await this.page.goto(this.fileManagerPageUrlFactory(this.page.url().split('/index.html')[0]));
          }
      }

      export class FileManagerPage {
          publicHtmlDirSelector = '.icon-publichtml';
          extractFileBtnSelector = '#action-extract';
          extractSubmitBtnSelector = '#extract_c .ft .default';
          fileManagerPageUrlFactory = (cPanelUrl) => `${cPanelUrl}/filemanager/index.html`;
          fileToExtractSelectorFactory = (filename) => `[title="${filename}"]`;

          constructor(page) {
              this.page = page;
          }

          async extractFile(filename) {
              await this.page.goto(this.fileManagerPageUrlFactory(this.page.url().split('/filemanager/')[0]));
              const publicHtmlDirElement = await this.page.waitForSelector(this.publicHtmlDirSelector);
              await publicHtmlDirElement.click();
              const fileToExtract = await this.page.waitForSelector(this.fileToExtractSelectorFactory(filename));
              await fileToExtract.click();
              const extractFilesBtn = await this.page.waitForSelector(this.extractFileBtnSelector);
              await extractFilesBtn.click();
              const extractSubmitBtn = await this.page.waitForSelector(this.extractSubmitBtnSelector);
              await extractSubmitBtn.click();
          }
      }

      export class UploadFilesPage {
          uploadFileInputSelector = 'input[type=file]';
          uploadFilePageUrlFactory = (cPanelUrl) => `${cPanelUrl}/upload-ajax.html?file=&fileop=&dir=%2Fhome%2Fmlodycyc%2Fpublic_html&dirop=&charset=&file_charset=&baseurl=&basedir=`;

          constructor(page) {
              this.page = page;
          }

          async openUploadFilePage() {
              await this.page.goto(this.uploadFilePageUrlFactory(this.page.url().split('/index.html')[0]));
          }

          async uploadFile(pathToFile) {
              const elementHandle = await this.page.$(this.uploadFileInputSelector);
              await elementHandle.uploadFile(pathToFile);
              await time.sleep(10_000);
          }
      }
      ```
  </Tabs.Tab>
  <Tabs.Tab>
      ```js copy
      export const time = {
          /**
           * @param {number} ms
           * @returns {Promise<void>}
           */
          sleep: (ms = 5000) => new Promise(resolve => setTimeout(resolve, ms))
      };


      /**
       * @typedef {Object} Page
       * @property {() => Promise<void>} waitForNavigation - waits for navigation to finish
       */
      export const nav = {
          /**
           * @param {Page} page
           * @param {() => Promise<unknown>} promise - promise to wait for
           * @returns {Promise<Awaited<?>[]>} - resolves when navigation by given promise is finished
           */
          waitFor:  async (page, promise) =>  await Promise.all([
              page.waitForNavigation(),
              promise()
          ])
      };

      /** Adds 4 spaces in front of the given string */
      export const indent = str => `    ${str}`;
      ```
  </Tabs.Tab>
  <Tabs.Tab>
      ```dotenv copy
      USERNAME=your_username
      PASSWORD=your_password
      ```
  </Tabs.Tab>
  <Tabs.Tab>
      ```json copy
      {
        "name": "deploy",
        "version": "1.0.0",
        "description": "Deployment script for CPanel",
        "main": "index.js",
        "type": "module",
        "scripts": {
          "start": "node ./index.js",
          "deploy": "node ./index.js"
        },
        "keywords": [],
        "author": "QUAK Kacper Walczak",
        "license": "ISC",
        "dependencies": {
          "dotenv": "^16.4.5",
          "puppeteer": "^22.9.0"
        }
      }

      ```
  </Tabs.Tab>

</Tabs>

### Build bash pipeline

We want to execute build, export to static files, zip and deploy to CPanel.

```bash copy
echo "Building zip: $1"
pnpm build
pnpm export
cd out
zip $1 -r . # zip all files
cd ../scripts/deploy
echo "Deploying zip: $1"
pnpm run deploy $1 # deploy the zip file
```

### Run pipeline

To run the pipeline we need to execute the bash script with the zip file name.

*Remember to create* `srcipts/deploy/process-screenshots` *folder* before run if one does not exist.

```bash copy
$ sh scripts/build-deploy.sh 'Archive_19_05_2024_3.zip'
```

## Conclusion

In this article we have learned how to deploy a static HTML website to a shared hosting CPanel using a CD pipeline.

<section className="rounded-2xl bg-lines flex mt-10 mb-20 h-20 w-full"></section>

<LatestReadings />
